#!/bin/bash

set -e

path=$(ctx node attributes path)

ctx download-resource /tmp/php7.0-fpm_7.0.33-0ubuntu0.16.04.6_amd64.deb global-scripts/Artifacts/php7.0-fpm_7.0.33-0ubuntu0.16.04.6_amd64.deb

dpkg -i --force-all /tmp/php7.0-fpm_7.0.33-0ubuntu0.16.04.6_amd64.deb
sed -i 's/(= 7.0.33-0ubuntu0.16.04.6)//g' /var/lib/dpkg/status

apt-mark hold php7.0-fpm

rm -f /tmp/php7.0-fpm_7.0.33-0ubuntu0.16.04.6_amd64.deb

/etc/init.d/php7.0-fpm restart

echo "<?php echo 'test 123';" > $path/test.php

# echo "server {
# 	listen 80;

# 	server_name _;
# 	root /var/www/html;

# 	index index.html index.php index.htm index.nginx-debian.html;

# 	location ~ [^/]\.php(/|\$) {
# 		fastcgi_split_path_info ^(.+\.php)(/.+)\$;
# 		fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
# 		fastcgi_index index.php;
# 		include fastcgi_params;
# 		fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
# 		fastcgi_param PATH_INFO \$fastcgi_path_info;
# 		fastcgi_hide_header X-Powered-By;
# 	}
# }
# " > /etc/nginx/sites-enabled/default

echo 'server {
	listen 80;

	server_name _;
	root /var/www/html;

	index index.html index.php index.htm index.nginx-debian.html;

	location ~ [^/]\.php(/|$) {
	#	try_files $uri =404;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
		fastcgi_index index.php;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
		fastcgi_param PATH_INFO $fastcgi_path_info;
		fastcgi_hide_header X-Powered-By;
	}
}' > /etc/nginx/sites-enabled/default

service nginx restart