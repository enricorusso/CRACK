set -e

ID="unknown"
test -f /etc/os-release && source /etc/os-release

fromUser=$(ctx node attributes fromUser)
toUser=$(ctx node attributes toUser)

if [ "$proxy_url" != "" ]; then
    echo "Proxy: $proxy_url"
    export http_proxy="$proxy_url"
    export https_proxy="$proxy_url"
fi

echo -n "Distro: "
case $ID in
    ubuntu|debian)
        echo "ubuntu/debian"

        if [ ! $(which sudo) ]; then
            # update sources
            if [ $(stat -c %y /var/lib/apt/periodic/update-success-stamp | cut -d' ' -f 1) != $(date +%Y-%m-%d) ]; then
                apt update
            fi

            apt install sudo
        fi

        echo "$fromUser ALL=($toUser) NOPASSWD: /usr/bin/apt-get" >> /etc/sudoers
        ;;
    *)
        echo "distro $ID not supported :("
        ;;
esac